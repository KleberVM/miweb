{% extends 'encuesta/base.html' %}
{% load widget_tweaks %}

{% block title %}Completar Encuesta{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Barra de Progreso -->
        <div class="progress-container">
            <div class="progress-bar-custom">
                <div class="progress-fill" id="progressBar">0%</div>
            </div>
            <div class="progress-text" id="progressText"><span class="material-icons">assignment</span> Completa la encuesta: 0 de 6 secciones</div>
        </div>

        <div class="card shadow-lg mb-5">
            <div class="card-header bg-primary text-white text-center">
                <h2><span class="material-icons" style="font-size: 32px; vertical-align: middle;">poll</span> Encuesta Electoral 2025</h2>
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate id="surveyForm">
                    {% csrf_token %}
                    
                    <!-- Sección 1: Datos Demográficos y Socioeconómicos -->
                    <div class="card mb-4 section-card" data-section="1">
                        <div class="card-header bg-secondary text-white">
                            <h3>
                                <span class="section-icon material-icons">person</span>
                                <span class="typewriter-text">Sección 1: Datos Demográficos y Socioeconómicos</span>
                            </h3>
                            <p class="text-white-50 mb-0 mt-2" style="font-size: 0.9rem;">Información básica sobre tu perfil personal, educativo y económico</p>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_nombre" class="form-label">Nombre </label>
                                    {{ form.nombre|add_class:"form-control" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_correo" class="form-label">Correo electrónico </label>
                                    {{ form.correo|add_class:"form-control" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_edad" class="form-label">Rango de edad</label>
                                    {{ form.edad|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_genero" class="form-label">Género</label>
                                    {{ form.genero|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_ciudad" class="form-label">Departamento</label>
                                    {{ form.ciudad|add_class:"form-select" }}
                                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="id_localidad" class="form-label">Localidad</label>
                                    {{ form.localidad|add_class:"form-control" }}
                                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_situacion_educativa" class="form-label">Situación educativa</label>
                                    {{ form.situacion_educativa|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_profesion_carrera" class="form-label">Profesión o carrera</label>
                                    {{ form.profesion_carrera|add_class:"form-control" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_estrato_socioeconomico" class="form-label">Estrato socioeconómico</label>
                                    {{ form.estrato_socioeconomico|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_estatus_laboral" class="form-label">Estatus laboral</label>
                                    {{ form.estatus_laboral|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_contribuye_familia" class="form-label">¿Contribuye económicamente a su familia?</label>
                                    {{ form.contribuye_familia|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_nivel_ingreso" class="form-label">Nivel de ingresos</label>
                                    {{ form.nivel_ingreso|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sección 2: Intención de voto y alineamiento ideológico -->
                    <div class="card mb-4 section-card" data-section="2">
                        <div class="card-header bg-secondary text-white">
                            <h3>
                                <span class="section-icon material-icons">how_to_vote</span>
                                <span class="typewriter-text">Sección 2: Intención de Voto y Alineamiento Ideológico</span>
                            </h3>
                            <p class="text-white-50 mb-0 mt-2" style="font-size: 0.9rem;">Tu preferencia electoral y posición política actual</p>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_intencion_voto" class="form-label">Si las elecciones presidenciales fueran hoy, ¿por cuál candidato votaría?</label>
                                    {{ form.intencion_voto|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_firmeza_voto" class="form-label">¿Qué tan seguro está de su decisión de voto? (1 = Nada seguro, 5 = Totalmente seguro)</label>
                                    {{ form.firmeza_voto|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_alineamiento_ideologico" class="form-label">En el espectro político, ¿con qué posición se identifica más?</label>
                                    {{ form.alineamiento_ideologico|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_influencia_entorno" class="form-label">¿Cuánto influye la opinión de su familia o amigos en su decisión de voto? (1 = Nada, 5 = Mucho)</label>
                                    {{ form.influencia_entorno|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="id_motivacion_voto" class="form-label">¿Cuál es la razón principal que lo motiva a participar en las elecciones?</label>
                                    {{ form.motivacion_voto|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sección 3: Factores de decisión -->
                    <div class="card mb-4 section-card" data-section="3">
                        <div class="card-header bg-secondary text-white">
                            <h3>
                                <span class="section-icon material-icons">balance</span>
                                <span class="typewriter-text">Sección 3: Factores de Decisión</span>
                            </h3>
                            <p class="text-white-50 mb-0 mt-2" style="font-size: 0.9rem;">Temas y políticas que influyen en tu elección de candidato</p>
                            <p class="text-white-50 mb-0 mt-1" style="font-size: 0.85rem;">Califique la importancia de cada factor (1 = Nada importante, 5 = Muy importante)</p>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_estabilidad" class="form-label">Estabilidad económica</label>
                                    {{ form.estabilidad|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_empleo" class="form-label">Generación de empleo</label>
                                    {{ form.empleo|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_deuda" class="form-label">Manejo de la deuda pública</label>
                                    {{ form.deuda|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_calidad" class="form-label">Calidad educativa</label>
                                    {{ form.calidad|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_becas" class="form-label">Becas y apoyo estudiantil</label>
                                    {{ form.becas|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_corrupcion_justicia" class="form-label">Lucha contra la corrupción</label>
                                    {{ form.corrupcion_justicia|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_salud" class="form-label">Sistema de salud</label>
                                    {{ form.salud|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_seguridad_ciudadana" class="form-label">Seguridad ciudadana</label>
                                    {{ form.seguridad_ciudadana|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_cambio_climatico" class="form-label">Cambio climático</label>
                                    {{ form.cambio_climatico|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_temaGenero" class="form-label">Políticas de género</label>
                                    {{ form.temaGenero|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_derechos_sociales" class="form-label">Derechos sociales</label>
                                    {{ form.derechos_sociales|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_modelo_desarrollo" class="form-label">Modelo de desarrollo</label>
                                    {{ form.modelo_desarrollo|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_PropuestaCandidatoNegativo" class="form-label">Si una propuesta de su candidato afectara negativamente las relaciones diplomáticas con un país vecino, ¿qué tan probable sería que usted mantenga su voto?</label>
                                    {{ form.PropuestaCandidatoNegativo|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_descontentoCandidato" class="form-label">Si un país u organismo internacional importante mostrara su descontento con la posible elección de su candidato, ¿qué tan probable sería que usted mantenga su voto?</label>
                                    {{ form.descontentoCandidato|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sección 4: Percepción de candidatos y atributos -->
                    <div class="card mb-4 section-card" data-section="4">
                        <div class="card-header bg-secondary text-white">
                            <h3>
                                <span class="section-icon material-icons">groups</span>
                                <span class="typewriter-text">Sección 4: Percepción de Candidatos y Atributos</span>
                            </h3>
                            <p class="text-white-50 mb-0 mt-2" style="font-size: 0.9rem;">Evalúa las cualidades y características de cada candidato</p>
                        </div>
                        <div class="card-body">
                            <h4 class="mb-3">Rodrigo Paz Pereira (1-5)</h4>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_experiencia_gestion_paz" class="form-label">Experiencia en gestión</label>
                                    {{ form.experiencia_gestion_paz|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_honestidad_paz" class="form-label">Honestidad</label>
                                    {{ form.honestidad_paz|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_capacidad_unir_paz" class="form-label">Capacidad de unir</label>
                                    {{ form.capacidad_unir_paz|add_class:"form-select" }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_conexion_jovenes_paz" class="form-label">Conexión con jóvenes</label>
                                    {{ form.conexion_jovenes_paz|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_liderazgo_paz" class="form-label">Liderazgo</label>
                                    {{ form.liderazgo_paz|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_propuestas_claras_paz" class="form-label">Propuestas claras</label>
                                    {{ form.propuestas_claras_paz|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <h4 class="mb-3 mt-4">Jorge Quiroga Ramírez (1-5)</h4>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_experiencia_gestion_tuto" class="form-label">Experiencia en gestión</label>
                                    {{ form.experiencia_gestion_tuto|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_honestidad_tuto" class="form-label">Honestidad</label>
                                    {{ form.honestidad_tuto|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_capacidad_unir_tuto" class="form-label">Capacidad de unir</label>
                                    {{ form.capacidad_unir_tuto|add_class:"form-select" }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_conexion_jovenes_tuto" class="form-label">Conexión con jóvenes</label>
                                    {{ form.conexion_jovenes_tuto|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_liderazgo_tuto" class="form-label">Liderazgo</label>
                                    {{ form.liderazgo_tuto|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_propuestas_claras_tuto" class="form-label">Propuestas claras</label>
                                    {{ form.propuestas_claras_tuto|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3 mt-4">
                                <div class="col-md-6">
                                    <label for="id_medio_influencia" class="form-label">¿Cuál es el principal medio por el que recibe información política?</label>
                                    {{ form.medio_influencia|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_confianza_redes" class="form-label">¿Cuánto confía en la información política que ve en redes sociales? (1-5)</label>
                                    {{ form.confianza_redes|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_conocimiento_economico" class="form-label">¿ Es importante que los candidatos sepan de economía ?</label>
                                    {{ form.conocimiento_economico|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_influencia_imagen" class="form-label">¿Qué tanto influye la imagen personal (forma de vestir, expresarse, o comportamiento en medios) en su percepción del candidato?(1-5)</label>
                                    {{ form.influencia_imagen|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_cambio_opinion_debates" class="form-label">¿Ha cambiado su opinión después de debates?</label>
                                    {{ form.cambio_opinion_debates|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sección 5: Impacto emocional y percepción de futuro -->
                    <div class="card mb-4 section-card" data-section="5">
                        <div class="card-header bg-secondary text-white">
                            <h3>
                                <span class="section-icon material-icons">psychology</span>
                                <span class="typewriter-text">Sección 5: Impacto Emocional y Percepción de Futuro</span>
                            </h3>
                            <p class="text-white-50 mb-0 mt-2" style="font-size: 0.9rem;">Tus sentimientos y expectativas sobre el proceso electoral</p>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_optimismo_futuro" class="form-label">¿Qué tan optimista se siente sobre el futuro del país? (1-5)</label>
                                    {{ form.optimismo_futuro|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_emocion_dominante" class="form-label">¿Qué emoción predomina al pensar en las elecciones?</label>
                                    {{ form.emocion_dominante|add_class:"form-select" }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_percepcion_eficacia" class="form-label">¿Cree que su voto puede generar un cambio real?</label>
                                    {{ form.percepcion_eficacia|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sección 6: Escenarios hipotéticos de simulación -->
                    <div class="card mb-4 section-card" data-section="6">
                        <div class="card-header bg-secondary text-white">
                            <h3>
                                <span class="section-icon material-icons">lightbulb</span>
                                <span class="typewriter-text">Sección 6: Escenarios Hipotéticos</span>
                            </h3>
                            <p class="text-white-50 mb-0 mt-2" style="font-size: 0.9rem;">Situaciones posibles que podrían influir en tu decisión de voto</p>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="id_confianza_expertos" class="form-label">Si un candidato admitiera que dejaría las decisiones económicas a sus “expertos”, ¿qué percepción tendría?</label>
                                    {{ form.confianza_expertos|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_reaccion_escandalo" class="form-label">Si se descubriera un escándalo de corrupción confirmado, ¿cuánto afectaría su voto? (1-5)</label>
                                    {{ form.reaccion_escandalo|add_class:"form-select" }}
                                </div>
                                <div class="col-md-4">
                                    <label for="id_reaccion_bonos" class="form-label">Si un candidato propusiera aumentar los bonos sociales o crearía nuevos bonos, ¿cómo afectaría eso su intención de voto?</label>
                                    {{ form.reaccion_bonos|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Enviar Encuesta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validación de formulario
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()
    
    // ==========================================
    // BARRA DE PROGRESO DINÁMICA
    // ==========================================
    const form = document.getElementById('surveyForm');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const sections = document.querySelectorAll('.section-card');
    const totalSections = sections.length;
    
    // Función para calcular el progreso de una sección
    function getSectionProgress(section) {
        const inputs = section.querySelectorAll('input, select, textarea');
        let filled = 0;
        let total = inputs.length;
        
        inputs.forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                // Para checkboxes y radios, verificar si alguno del grupo está marcado
                const name = input.name;
                const checked = section.querySelector(`input[name="${name}"]:checked`);
                if (checked && input === checked) {
                    filled++;
                }
            } else if (input.value && input.value.trim() !== '') {
                filled++;
            }
        });
        
        return total > 0 ? (filled / total) : 0;
    }
    
    // Variable para rastrear progreso anterior
    let previousProgress = 0;
    let previousCompletedSections = 0;
    
    // Función para actualizar la barra de progreso
    function updateProgress() {
        let completedSections = 0;
        let totalProgress = 0;
        
        sections.forEach(section => {
            const sectionProgress = getSectionProgress(section);
            totalProgress += sectionProgress;
            
            // Marcar sección como completada si tiene más del 80% lleno
            if (sectionProgress >= 0.8) {
                completedSections++;
                section.classList.add('in-view');
            } else {
                section.classList.remove('in-view');
            }
        });
        
        const overallProgress = (totalProgress / totalSections) * 100;
        
        // Añadir efecto de pulso si el progreso aumentó
        if (overallProgress > previousProgress) {
            progressBar.classList.add('pulse');
            setTimeout(() => {
                progressBar.classList.remove('pulse');
            }, 500);
        }
        
        // Actualizar valores
        progressBar.style.width = overallProgress + '%';
        progressBar.textContent = Math.round(overallProgress) + '%';
        
        // Actualizar texto con icono animado
        const icon = '<span class="material-icons">assignment</span>';
        if (completedSections === totalSections) {
            progressText.innerHTML = `${icon} ¡Encuesta completada! 🎉 ${completedSections} de ${totalSections} secciones`;
        } else {
            progressText.innerHTML = `${icon} Completa la encuesta: ${completedSections} de ${totalSections} secciones`;
        }
        
        // Cambiar color según progreso con transición suave
        if (overallProgress < 33) {
            progressBar.style.background = 'linear-gradient(90deg, #dc143c 0%, #ff1744 100%)';
        } else if (overallProgress < 66) {
            progressBar.style.background = 'linear-gradient(90deg, #003d5c 0%, #005580 100%)';
        } else if (overallProgress < 100) {
            progressBar.style.background = 'linear-gradient(90deg, #005580 0%, #28a745 100%)';
        } else {
            progressBar.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 100%)';
        }
        
        // Actualizar variables de seguimiento
        previousProgress = overallProgress;
        previousCompletedSections = completedSections;
    }
    
    // Escuchar cambios en todos los inputs
    form.addEventListener('change', updateProgress);
    form.addEventListener('input', updateProgress);
    
    // Actualizar al cargar la página
    updateProgress();
    
    // ==========================================
    // ANIMACIÓN DE MÁQUINA DE ESCRIBIR
    // ==========================================
    const typewriterElements = document.querySelectorAll('.typewriter-text');
    
    // Resetear animaciones al cargar
    typewriterElements.forEach(element => {
        element.style.animation = 'none';
        element.style.borderRight = 'none';
    });
    
    // Configurar Intersection Observer para animar cuando sea visible
    const observerOptions = {
        threshold: 0.3,
        rootMargin: '-50px'
    };
    
    const typewriterObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !entry.target.classList.contains('typed')) {
                // Iniciar animación
                entry.target.style.borderRight = '3px solid #dc143c';
                entry.target.style.animation = 'typing 2s steps(40, end), blink 0.75s step-end infinite';
                
                // Después de la animación, quitar el borde parpadeante
                setTimeout(() => {
                    entry.target.classList.add('typed');
                    entry.target.style.borderRight = 'none';
                    entry.target.style.animation = 'none';
                }, 2100);
            }
        });
    }, observerOptions);
    
    // Observar cada elemento de máquina de escribir
    typewriterElements.forEach(element => {
        typewriterObserver.observe(element);
    });
    
    // ==========================================
    // SCROLL SUAVE A SECCIONES
    // ==========================================
    sections.forEach((section, index) => {
        section.addEventListener('click', function(e) {
            // Solo si se hace clic en el header
            if (e.target.closest('.card-header')) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
</script>
{% endblock %}